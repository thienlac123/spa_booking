@model IEnumerable<DoAnSPA.Models.GioHangItem>
@using System.Linq

@{
    ViewData["Title"] = "Giỏ hàng của bạn";

    decimal TongTien = 0;
    if (Model != null && Model.Any())
    {
        TongTien = Model.Sum(i => i.SanPham.Gia * i.SoLuong);
    }

    string VND(decimal x) => x.ToString("#,0") + " ₫";
}

<div class="container py-5">
    <div class="row mb-4">
        <div class="col">
            <h2 class="fw-bold text-primary"><i class="fas fa-shopping-basket me-2"></i>@ViewData["Title"]</h2>
        </div>
    </div>

    @if (TempData["Success"] is string sMsg)
    {
        <div class="alert alert-success shadow-sm border-0"><i class="fas fa-check-circle me-2"></i>@sMsg</div>
    }
    @if (TempData["Error"] is string eMsg)
    {
        <div class="alert alert-danger shadow-sm border-0"><i class="fas fa-exclamation-circle me-2"></i>@eMsg</div>
    }

    @if (Model == null || !Model.Any())
    {
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-shopping-cart fa-4x text-muted opacity-25"></i>
            </div>
            <h4 class="text-muted">Giỏ hàng của bạn đang trống</h4>
            <p class="mb-4">Hãy khám phá các sản phẩm tuyệt vời của chúng tôi nhé!</p>
            <a href="/SanPham" class="btn btn-primary rounded-pill px-4">
                <i class="fas fa-arrow-left me-2"></i>Quay lại mua sắm
            </a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm border-0 rounded-3 overflow-hidden">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 text-secondary">Danh sách sản phẩm (@Model.Count())</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th style="width: 50px;" class="text-center">#</th>
                                    <th>Sản phẩm</th>
                                    <th class="text-end">Đơn giá</th>
                                    <th class="text-center" style="width: 100px;">SL</th>
                                    <th class="text-end">Thành tiền</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    var stt = 1;
                                }
                                @foreach (var item in Model)
                                {
                                    var thanhTien = item.SanPham.Gia * item.SoLuong;
                                    <tr>
                                        <td class="text-center text-muted">@stt</td>

                                        <td>
                                            <div class="d-flex align-items-center">
                                                @{
                                                    // Lấy link ảnh sản phẩm, fallback nếu null
                                                    var raw = item.SanPham.HinhAnhUrl;
                                                    string imgUrl;

                                                    if (string.IsNullOrWhiteSpace(raw))
                                                    {
                                                        // ảnh mặc định nếu sp chưa có hình
                                                        imgUrl = Url.Content("~/images/no-image.png");
                                                    }
                                                    else if (raw.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                                                    {
                                                        imgUrl = raw; // link tuyệt đối
                                                    }
                                                    else
                                                    {
                                                        // link tương đối trong wwwroot
                                                        imgUrl = Url.Content(raw.StartsWith("~") ? raw : "~" + (raw.StartsWith("/") ? raw : "/" + raw));
                                                    }
                                                }

                                                <div class="cart-thumb me-3">
                                                    <img src="@imgUrl"
                                                         alt="@item.SanPham.TenSanPham"
                                                         class="img-fluid" />
                                                </div>

                                                <div>
                                                    <h6 class="mb-0 text-dark">@item.SanPham.TenSanPham</h6>
                                                    <small class="text-muted" style="font-size: 0.85em;">
                                                        @item.SanPham.MoTa
                                                    </small>
                                                </div>
                                            </div>
                                        </td>


                                        <td class="text-end">@VND(item.SanPham.Gia)</td>
                                        <td class="text-center">
                                            <span class="badge bg-light text-dark border px-3">@item.SoLuong</span>
                                        </td>
                                        <td class="text-end fw-bold text-primary">@VND(thanhTien)</td>
                                        <td class="text-center">
                                            <form asp-action="Remove" method="post">
                                                <input type="hidden" name="id" value="@item.GioHangItemId" />
                                                <button type="submit" class="btn btn-link text-danger p-0" title="Xoá sản phẩm" onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?');">
                                                    <i class="far fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    stt++;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-3">
                    <a href="/SanPham" class="text-decoration-none text-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Tiếp tục mua sắm
                    </a>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 rounded-3">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-file-invoice-dollar me-2"></i>Thanh toán</h5>
                    </div>
                    <div class="card-body p-4">
                        <form asp-action="Checkout" method="post" class="card p-3">
                         
                            <h5 class="mb-3">Thông tin giao hàng</h5>

                            <div class="mb-2">
                                <label class="form-label">Họ tên người nhận</label>
                                <input name="tenNguoiNhan" class="form-control" required />
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Số điện thoại</label>
                                <input name="soDienThoaiNhan" class="form-control" required />
                            </div>

                            <div class="mb-2">
                                <label class="form-label">Địa chỉ giao hàng</label>
                                <textarea name="diaChiNhan" class="form-control" rows="2" required></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Ghi chú (nếu có)</label>
                                <textarea name="ghiChu" class="form-control" rows="2"></textarea>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span class="text-muted">Tổng cộng:</span>
                                <h3 class="fw-bold text-primary mb-0">@VND(TongTien)</h3>
                            </div>

                            <hr class="my-4">


                            <h6 class="fw-bold mb-3">Phương thức thanh toán</h6>

                            <div class="form-check p-3 border rounded mb-2 d-flex align-items-center bg-light-hover transition">
                                <input class="form-check-input mt-0 me-3" type="radio" name="paymentMethod" value="MOMO" id="payMomo" checked style="cursor: pointer;">
                                <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="payMomo" style="cursor: pointer;">
                                    <span>Ví MoMo (QR)</span>
                                    <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" alt="MoMo" height="24" class="opacity-75">
                                </label>
                            </div>

                            <div class="form-check p-3 border rounded mb-2 d-flex align-items-center bg-light-hover transition">
                                <input class="form-check-input mt-0 me-3" type="radio" name="paymentMethod" value="VNPAY" id="payVnpay" style="cursor: pointer;">
                                <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="payVnpay" style="cursor: pointer;">
                                    <span>VNPAY QR</span>
                                    <i class="fas fa-qrcode text-primary fa-lg"></i>
                                </label>
                            </div>

                            <div class="form-check p-3 border rounded mb-4 d-flex align-items-center bg-light-hover transition">
                                <input class="form-check-input mt-0 me-3" type="radio" name="paymentMethod" value="TIENMAT" id="payCash" style="cursor: pointer;">
                                <label class="form-check-label w-100 d-flex justify-content-between align-items-center" for="payCash" style="cursor: pointer;">
                                    <span>Thanh toán khi nhận hàng</span>
                                    <i class="fas fa-money-bill-wave text-success fa-lg"></i>
                                </label>
                            </div>

                            <button type="submit" class="btn btn-success w-100 py-3 fw-bold rounded-pill shadow-sm btn-hover-effect">
                                <i class="fas fa-check me-2"></i>XÁC NHẬN THANH TOÁN
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    /* Optional custom styles for hover effects */
    .bg-light-hover:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }

    .btn-hover-effect:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25) !important;
    }

    .transition {
        transition: all 0.2s ease-in-out;
    }

    .cart-thumb {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cart-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
    }
</style>