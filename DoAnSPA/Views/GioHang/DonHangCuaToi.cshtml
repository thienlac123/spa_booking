@model IEnumerable<DoAnSPA.Models.DonHang>

@{
    ViewData["Title"] = "Lịch sử đơn hàng";

    // Hàm định dạng tiền tệ
    string VND(decimal x) => x.ToString("#,0") + " đ";

    // Hàm lấy text hiển thị trạng thái
    string TrangThaiText(string s) => s switch
    {
        "ChoThanhToan" => "Chờ thanh toán",
        "ChuanBi"or"DaThanhToan" => "Đang chuẩn bị hàng",
        "DangGiao" => "Đang giao hàng",
        "DaGiao"  => "Hoàn thành",
        "Huy" => "Đã hủy",
        _ => s
    };

    // Hàm lấy màu sắc cho trạng thái (Bootstrap class)
    string TrangThaiBadge(string s) => s switch
    {
        "DaGiao"  => "bg-success", // Màu xanh lá
        "Huy" => "bg-danger",                      // Màu đỏ
        "DangGiao" => "bg-primary",                // Màu xanh dương
        "ChoThanhToan" => "bg-warning text-dark",  // Màu vàng
        _ => "bg-info text-dark"                   // Màu xanh nhạt mặc định
    };
}

<div class="container py-4">
    <h2 class="mb-4 fw-bold text-secondary">📦 Đơn hàng của tôi</h2>

    @if (!Model.Any())
    {
        <div class="text-center py-5 bg-light rounded shadow-sm">
            <h4 class="text-muted">Bạn chưa có đơn hàng nào</h4>
           
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-3 ps-4">Mã đơn</th>
                                <th>Ngày đặt</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th class="text-end pe-4">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var o in Model)
                            {
                                <tr>
                                    <td class="ps-4 fw-bold text-primary">#@o.DonHangId</td>
                                    <td>
                                        <div class="small text-muted">
                                            @o.CreatedAt.AddHours(7).ToString("HH:mm")
                                        </div>
                                        <div class="fw-bold">
                                            @o.CreatedAt.AddHours(7).ToString("dd/MM/yyyy")
                                        </div>
                                    </td>
                                    <td class="fw-bold text-danger">@VND(o.TongTien)</td>
                                    <td>
                                        <span class="badge rounded-pill @TrangThaiBadge(o.TrangThai)">
                                            @TrangThaiText(o.TrangThai)
                                        </span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#orderModal-@o.DonHangId">
                                            Xem chi tiết
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        /* --- PHẦN TẠO MODAL CHI TIẾT (ẨN) --- */
        @foreach (var o in Model)
        {
            <div class="modal fade" id="orderModal-@o.DonHangId" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Chi tiết đơn hàng #@o.DonHangId</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3 p-3 bg-light rounded">
                                <p class="mb-1"><strong>Người nhận:</strong> @o.TenNguoiNhan</p>
                                <p class="mb-1"><strong>SĐT:</strong> @o.SoDienThoaiNhan</p>
                                <p class="mb-0"><strong>Địa chỉ:</strong> @o.DiaChiNhan</p>
                            </div>

                            <h6 class="border-bottom pb-2">Danh sách dịch vụ/sản phẩm</h6>
                            <ul class="list-group list-group-flush">
                                @foreach (var ct in o.ChiTiets)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <div>
                                            <span class="fw-bold">@ct.SanPham?.TenSanPham</span>
                                            <div class="small text-muted">Số lượng: x @ct.SoLuong</div>
                                        </div>
                                        <span class="text-primary">@VND(ct.ThanhTien)</span>
                                    </li>
                                }
                            </ul>

                            <div class="d-flex justify-content-between mt-3 pt-2 border-top">
                                <strong>Tổng cộng:</strong>
                                <strong class="text-danger fs-5">@VND(o.TongTien)</strong>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>